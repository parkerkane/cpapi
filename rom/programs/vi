local tArgs = { ... }

if #tArgs == 0 then
    error("Usage: vi <path>")
end

Keys = {
    up = 200,
    down = 208,
    left = 203,
    right = 205,
    lctrl = 29,
    rctrl = 97,
    lalt = 56,
    ralt = 184,
    lshift = 42,
    shift = 54,
    bspace = 14,
    enter = 28,
    f1 = 59,
    f2 = 60,
    f3 = 61,
    f4 = 62,
    f5 = 63,
    f6 = 64,
    f7 = 65,
    f8 = 66,
    f9 = 67,
    f10 = 68,
    tilde = 0,
}

Modes = { view = 0, edit = 1, ex = 2, search = 3, hold = 4 }

local mode = Modes.view;

local filename = shell.resolve(tArgs[1])
local readonly = fs.isReadOnly(filename)

if fs.exists(filename) and fs.isDir(filename) then
    error("Cannot edit a directory")
end

local w, h = term.getSize()
local x, y = 1, 1
local scrollX, scrollY = 0, 0
local cmdPos = 1
local cmdBuffer = ""

local searchString = ""
local searchPositionX = 0
local searchPositionY = 0
local holdMessage

local buffer = {}

local function load(filename)
    buffer = {}

    if fs.exists(filename) then
        local file = io.open(filename)

        repeat
            local line = file:read()
            table.insert(buffer, line)

            until not line
    else
        table.insert(buffer, "")
    end
end

local function save(filename)
    local file = io.open(filename, "w")
    if file then
        for n, sLine in ipairs(buffer) do
            file:write(sLine .. "\n")
        end
        file:close()
    end
end

local function updateCursorPosition()

    local realX = math.min(x - scrollX, buffer[y]:len() + 1)

    term.setCursorBlink(true)
    term.setCursorPos(realX, y - scrollY)
end

local function updateStatus()

    term.setCursorPos(1, h)
    term.clearLine()

    if mode == Modes.view or mode == Modes.edit then
        term.setCursorPos(5, h)

        local realX = math.min(x - scrollX, buffer[y]:len() + 1)
        term.write('L' .. y .. ' C' .. realX)

        if mode == Modes.edit then
            term.setCursorPos(20, h)
            term.write('** INSERT **')
        end

        updateCursorPosition()

    elseif mode == Modes.ex then
        term.write(': ' .. cmdBuffer)

        term.setCursorPos(2 + cmdPos, h)

    elseif mode == Modes.hold then
        term.write(holdMessage)

    elseif mode == Modes.search then
        term.write('/' .. cmdBuffer)

        term.setCursorPos(1 + cmdPos, h)
    end
end

local function updateLine()
    local line = buffer[y]
    term.setCursorPos(1 - scrollX, y - scrollY)
    term.clearLine()
    term.write(line)
    term.setCursorPos(x - scrollX, y - scrollY)
end

local function updateScreen()
    for y = 1, h - 1 do
        term.setCursorPos(1 - scrollX, y)
        term.clearLine()

        local line = buffer[y + scrollY]
        if line ~= nil then
            term.write(line)
        else
            term.write('~')
        end
    end
end

local function moveCursor(key)

    if key == Keys.left or key == 'h' then
        x = math.min(x, buffer[y]:len() + 1)
        x = x - 1

        if x == 0 and y > 1 then
            local newy = math.max(1, y - 1)
            x = buffer[newy]:len() + 1

            os.queueEvent('key', Keys.up)
        end

    elseif key == Keys.right or key == 'l' then
        x = x + 1

        if x > buffer[y]:len() + 1 and y ~= #buffer then
            x = 1
            os.queueEvent('key', Keys.down)
        end

    elseif key == Keys.up or key == 'k' then
        y = y - 1

    elseif key == Keys.down or key == 'j' then
        y = math.min(y + 1, #buffer)
    end

    local update = false

    while x - scrollX < 1 do
        scrollX = scrollX - 10

        if scrollX < 0 then
            scrollX = 0
            x = 1
        else
            update = true
        end
    end

    while x - scrollX > w do
        scrollX = scrollX + 10
        update = true
    end

    if y - scrollY < 1 then

        scrollY = scrollY - 1
        if scrollY < 0 then scrollY = 0 end

        y = scrollY + 1
        update = true
    end

    if y - scrollY > h - 1 then
        scrollY = scrollY + 1

        if scrollY > #buffer - h + 1 then
            scrollY = #buffer - h + 1
        end

        y = scrollY + h - 1
        update = true
    end

    if update then updateScreen() end

    updateStatus()
    updateCursorPosition()
end

local function runExCommand(cmd)
    if cmd == 'q' then
        os.queueEvent('quit')

    elseif cmd == 'w' then
        save(filename)

    elseif cmd == 'wq' or cmd == 'x' then
        save(filename)
        os.queueEvent('quit')

    elseif cmd == 'sh' then
        term.clear()
        term.setCursorPos(1, 1)
        shell.run('shell')
        print()

        updateScreen()
        updateCursorPosition()

    elseif cmd == 'wr' then
        save(filename)

        term.clear()
        term.setCursorPos(1, 1)
        shell.run('/' .. filename)

        mode = Modes.hold
        holdMessage = 'Press any key to continue..'
    end
end

local function doSearch()
    for i = searchPositionY, #buffer do
        local newPos = buffer[i]:find(searchString, searchPositionX + 1)
        searchPositionX = 0

        if newPos ~= nil then
            x = newPos
            y = i

            searchPositionX = x
            searchPositionY = y

            moveCursor()
            updateCursorPosition()
            return
        end
    end

    term.setCursorPos(1, h)
    term.clearLine()
    holdMessage = 'String found.'
    mode = Modes.hold
end

local viewModeListener = {
    [Keys.up] = moveCursor;
    [Keys.down] = moveCursor;
    [Keys.left] = moveCursor;
    [Keys.right] = moveCursor;

    h = moveCursor;
    j = moveCursor;
    k = moveCursor;
    l = moveCursor;

    i = function()
        mode = Modes.edit
        updateStatus()
    end;

    [':'] = function()
        cmdPos = 1
        cmdBuffer = ""
        mode = Modes.ex
        updateStatus()
    end;

    a = function()
        x = math.min(buffer[y]:len() + 1, x + 1)
        mode = Modes.edit
        updateStatus()
    end;

    ['$'] = function()
        x = buffer[y]:len() + 1
        moveCursor()
    end;

    ['^'] = function()
        x = 1
        moveCursor()
    end;

    ['0'] = function()
        x = 1
        moveCursor()
    end;

    ['/'] = function()
        cmdPos = 1
        cmdBuffer = ""
        mode = Modes.search
        updateStatus()
    end;

    ['n'] = function()
        doSearch()
    end;

    ['L'] = function()
        updateScreen()
        updateCursorPosition()
    end;
}

local editModeListener = {
    [Keys.up] = moveCursor;
    [Keys.down] = moveCursor;
    [Keys.left] = moveCursor;
    [Keys.right] = moveCursor;

    [Keys.lctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.rctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.enter] = function()
        local line = buffer[y]

        buffer[y] = buffer[y]:sub(1, x - 1)
        table.insert(buffer, y + 1, line:sub(x))

        x = 1
        y = y + 1

        updateScreen()
        updateCursorPosition()
    end;

    [Keys.bspace] = function()

        if x > 1 then
            x = x - 1
            buffer[y] = buffer[y]:sub(1, x - 1) .. buffer[y]:sub(x + 1)
        elseif y > 1 then
            local ln = buffer[y - 1]:len()
            buffer[y - 1] = buffer[y - 1] .. buffer[y]
            table.remove(buffer, y)

            x = ln + 1
            y = y - 1
        end
        updateScreen()
        updateCursorPosition()
    end;

    defaultChar = function(char)

        buffer[y] = buffer[y]:sub(1, x - 1) .. char .. buffer[y]:sub(x)
        x = x + 1
        moveCursor()
        updateLine()
        updateCursorPosition()
    end
}

local exModeListener = {
    [Keys.lctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.rctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.left] = function()
        cmdPos = math.max(1, cmdPos - 1)
        updateStatus()
    end;

    [Keys.right] = function()
        cmdPos = math.min(cmdBuffer:len() + 1, cmdPos + 1)
        updateStatus()
    end;

    [Keys.bspace] = function()
        cmdPos = math.max(1, cmdPos - 1)
        cmdBuffer = cmdBuffer:sub(1, cmdPos - 1) .. cmdBuffer:sub(cmdPos + 1)

        updateStatus()
    end;

    [Keys.enter] = function()
        mode = Modes.view
        runExCommand(cmdBuffer)
        updateStatus()
    end;

    defaultChar = function(char)

        cmdBuffer = cmdBuffer:sub(1, cmdPos - 1) .. char .. cmdBuffer:sub(cmdPos)
        cmdPos = cmdPos + 1

        updateStatus()
    end
}

local holdListener = {
    defaultKey = function()
        mode = Modes.view
        updateScreen()
        updateStatus()
    end
}

local searchListener = {
    [Keys.lctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.rctrl] = function()
        mode = Modes.view
        updateStatus()
    end;

    [Keys.left] = function()
        cmdPos = math.max(1, cmdPos - 1)
        updateStatus()
    end;

    [Keys.right] = function()
        cmdPos = math.min(cmdBuffer:len() + 1, cmdPos + 1)
        updateStatus()
    end;

    [Keys.bspace] = function()
        cmdPos = math.max(1, cmdPos - 1)
        cmdBuffer = cmdBuffer:sub(1, cmdPos - 1) .. cmdBuffer:sub(cmdPos + 1)

        updateStatus()
    end;

    [Keys.enter] = function()
        mode = Modes.view

        searchPositionX = 0
        searchPositionY = 1
        searchString = cmdBuffer

        doSearch()

        updateStatus()
    end;

    defaultChar = function(char)

        cmdBuffer = cmdBuffer:sub(1, cmdPos - 1) .. char .. cmdBuffer:sub(cmdPos)
        cmdPos = cmdPos + 1

        updateStatus()
    end
}

local allListeners = {
    [Modes.view] = viewModeListener,
    [Modes.edit] = editModeListener,
    [Modes.ex] = exModeListener,
    [Modes.search] = searchListener,
    [Modes.hold] = holdListener,
}

load(filename)

term.clear()

updateScreen()
updateStatus()
updateCursorPosition()

cp.main({
    key = function(keyCode)
        local listener = allListeners[mode]
        if listener == null then return end

        local func = listener[keyCode] or listener.defaultKey
        if func == nil then return end

        func(keyCode)
    end;

    char = function(char)
        local listener = allListeners[mode]
        if listener == null then return end

        local func = listener[char] or listener.defaultChar
        if func == nil then return end

        func(char)
    end;

    quit = function()
        term.clear()
        term.setCursorPos(1, 1)
    end;
})